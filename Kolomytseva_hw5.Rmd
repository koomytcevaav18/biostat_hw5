---
title: "Untitled"
author: "Kolomytseva_hw5"
date: "2024-03-29"
output: html_document
---

# ДЗ 5. Построение регрессионных моделей и анализ выживаемости

# Коломыцева Анна

Загрузка библиотек

```{r echo: false}
library(tidyverse)
#library(car)
library(survival)
library(ggsurvfit)
#remotes::install_github("easystats/report")
library("report")
```

Чтение датасета

```{r}
data_hw5 <- read.csv("wisconsin_breast_cancer.csv")
head(data_hw5)
```

В колонке diagnosis содержится информация об опухоли (M = злокачественная, B = доброкачественная).

## Задание 1

Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли и средней площади (a), среднего периметра (b), средней симметричности (c).

Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.

```{r}
# связь среднего радиуса опухоли и средней площади (а)
model_a <- lm(radius_mean ~ area_mean, data = data_hw5)
summary(model_a)
# проверка допущений:
# линейность зависимости
ggplot(data_hw5, aes(area_mean, radius_mean))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(titlt = "Зависимоть среднего радиуса опухоли от средней площади",
       y = "средний радиус опухоли",
       x = "средняя площадь опухоли")
# нормальное распределение остатков
#qqPlot(residuals(model_a))
# гомоскедастичность
#plot(model_a, which = 1)
```

```{r}
# связь среднего радиуса опухоли и среднего периметра (б)
model_b <- lm(radius_mean ~ perimeter_mean, data = data_hw5)
summary(model_b)
# проверка допущений:
# линейность зависимости
ggplot(data_hw5, aes(perimeter_mean, radius_mean))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(titlt = "Зависимоть среднего радиуса опухоли от среднего периметра",
       y = "средний радиус опухоли",
       x = "средний периметр опухоли")
# нормальное распределение остатков
#qqPlot(residuals(model_b))
# гомоскедастичность
#plot(model_b, which = 1)
```

```{r}
# связь среднего радиуса опухоли и средней симметричности (в)
model_c <- lm(radius_mean ~ symmetry_mean, data = data_hw5)
summary(model_c)
# проверка допущений:
# линейность зависимости
ggplot(data_hw5, aes(symmetry_mean, radius_mean))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(titlt = "Зависимоть среднего радиуса опухоли от средней симметричности",
       y = "средний радиус опухоли",
       x = "средняя симметричность опухоли")
# нормальное распределение остатков
#qqPlot(residuals(model_c))
# гомоскедастичность
#plot(model_c, which = 1)
```

### Результаты задания 1

Высокие значение F-статистик и малые значения p-value указывает на статистическую значимость моделей линейной регрессии для зависимостей среднего радиуса опухоли от средней площади (a), среднего периметра (b), средней симметричности (c). Однако наилучшим образом линейная регрессия описывает связь среднего радиуа и среднего периметра. Для связи среднего радиуса опухоли и средней площади остаточная стандартная ошибка (Residual standard error) равна 0.5591, что больше, чем в случае b. Здесь логично предположить нелинейную связь (площадь ~ квадрату радиуса). Еще большие значения p-value и Residual standard error наблюдаются в случае для связи среднего радиуа и средней симметричности (c). Здесь очень большой разброс точек относительно регрессионной прямой, и по-визимому между радиусом и симметричностью слабая корреляция.
```{r}
cor(data_hw5$symmetry_mean, data_hw5$radius_mean, 
    method = "spearman")
```
## Задание 2

Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0. 

```{r}
data_hw5 <- (data_hw5 %>% 
  mutate(diagnosis = if_else(diagnosis=="M", 1, 0)))
```

Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (a), средней площади (b), средней текстуры (c). Постройте графики. 

```{r}
logreg_a <- glm(diagnosis ~ radius_mean, data = data_hw5, family = "binomial")
print(report(logreg_a))

ggplot(data_hw5, aes(x = radius_mean, y = diagnosis)) +
  geom_point() +
  geom_smooth(method = "glm", 
              method.args = list(family = "binomial"))
```

```{r}
logreg_b <- glm(diagnosis ~ area_mean, data = data_hw5, family = "binomial")
print(report(logreg_b))

ggplot(data_hw5, aes(x = area_mean, y = diagnosis)) +
  geom_point() +
  geom_smooth(method = "glm", 
              method.args = list(family = "binomial"))
```

```{r}
logreg_c <- glm(diagnosis ~ texture_mean, data = data_hw5, family = "binomial")
print(report(logreg_c))

ggplot(data_hw5, aes(x = texture_mean, y = diagnosis)) +
  geom_point() +
  geom_smooth(method = "glm", 
              method.args = list(family = "binomial"))
```

Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.

```{r}
logreg_multifactor <- glm(diagnosis ~ texture_mean + area_mean + radius_mean, 
                          data = data_hw5, family = "binomial")
print(report(logreg_multifactor))
```
### Результаты задания 2

Построенные модели, прогнозирующие вероятность возникновения злокачественной опухоли от (по отдельности) среднего радиуса (a), средней площади (b), средней текстуры (c) показали p-значения много меньше $alpha=0.05$, что указывает на статистическую значимость эффектов этих трех параметров, причем эффекты положительные. В модели прогноза вероятности возникновения злокачественной опухоли от всех трех перечисленных факторов статистическия значимость и положительный эффект обнаружены только для средней текстуры. 

## Задание 3

Для выполнения этого задания вам понадобится датасет lung, который встроен в пакет survival. Установите этот пакет и загрузите датасет.

```{r}
lung <- survival::lung
lung
```

Датасет содержит следующий набор переменных:

-   inst: код учреждения;
-   time: время выживаемости в днях;
-   status: 1 = цензурирование, 2 = смерть;
-   age: возраст в годах;
-   sex: мужской = 1, женский = 2;
-   ph.ecog: шкала опросника ECOG (оценку проводит врач).
    -   0 = отсутствие симптомов,
    -   1 = симптомы есть, но пациент наблюдается амбулаторно,
    -   2 = меньше половины дня пациент вынужден проводить в постели,
    -   3 = больше половины дня нуждается в отдыхе лежа, но не прикован к постели,
    -   4 = прикован к постели;
-   ph.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке врача;
-   pat.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке пациента;
-   meal.cal: калории потребляемой пищи;
-   wt.loss: потеря веса за последние полгода.

Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.

```{r}
lung <- (lung %>% 
  mutate(event = if_else(status==2, 1, 0)))
```

Изучите работу функций Surv(), survfit() и ggsurvplot():

Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним). Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты. 

```{r}
surv_fit <- survfit(Surv(time, status) ~ sex, data = lung)

surv_fit %>% 
  ggsurvfit() +
  labs(
    x = "Дни",
    y = "Вероятность выживания"
  ) + 
  add_confidence_interval() +
  add_risktable()
```

Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график. 

```{r}
surv_fit %>% 
  ggsurvfit(type = "risk") +
  labs(
    x = "Дни",
    y = "Вероятность смерти"
  ) + 
  add_confidence_interval()
```

С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы можете сказать о полученных результатах?

```{r}
cox <- coxph(Surv(time, status) ~ sex, data = lung)
summary(cox)

```

